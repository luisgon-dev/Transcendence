---
phase: 04-live-game-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Transcendence.Data/Models/Auth/ApiClientKey.cs
  - Transcendence.Data/Repositories/Interfaces/IApiClientKeyRepository.cs
  - Transcendence.Data/Repositories/Implementations/ApiClientKeyRepository.cs
  - Transcendence.Data/Extensions/ServiceCollectionExtensions.cs
  - Transcendence.Service.Core/Services/Auth/Interfaces/IApiKeyService.cs
  - Transcendence.Service.Core/Services/Auth/Implementations/ApiKeyService.cs
  - Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  - Transcendence.WebAPI/Security/ApiKeyAuthenticationHandler.cs
  - Transcendence.WebAPI/Security/AuthPolicies.cs
  - Transcendence.WebAPI/Controllers/ApiKeysController.cs
  - Transcendence.WebAPI/Program.cs
autonomous: true

must_haves:
  truths:
    - "Clients can authenticate with X-API-Key header (AUTH-01)"
    - "Invalid/missing API keys return 401 without controller-side token parsing"
    - "API keys are stored hashed and can be revoked"
    - "Authorization policy AppOnly can protect app/admin endpoints"
  artifacts:
    - path: "Transcendence.WebAPI/Security/ApiKeyAuthenticationHandler.cs"
      provides: "ASP.NET Core authentication handler for X-API-Key"
      contains: "HandleAuthenticateAsync"
    - path: "Transcendence.Service.Core/Services/Auth/Implementations/ApiKeyService.cs"
      provides: "API key hash/validation/revocation logic"
      min_lines: 60
    - path: "Transcendence.WebAPI/Program.cs"
      provides: "Authentication scheme + authorization policy registration"
      contains: "AddAuthentication"
  key_links:
    - from: "ApiKeyAuthenticationHandler"
      to: "IApiKeyService"
      via: "Validate incoming key hash"
      pattern: "Validate"
    - from: "Controllers with [Authorize(Policy = \"AppOnly\")]"
      to: "ApiKeyAuthenticationHandler"
      via: "Authentication scheme pipeline"
      pattern: "AppOnly"
---

<objective>
Implement API key authentication foundation using ASP.NET Core middleware and policies.

Purpose: Unblock desktop app integration with secure app-level auth while preparing for dual-scheme auth in later plans.

Output: Working X-API-Key auth with `AppOnly` policy and management endpoints.
</objective>

<execution_context>
@C:\Users\luigon\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luigon\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-live-game-auth/04-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@Transcendence.WebAPI/Program.cs
@Transcendence.Data/Extensions/ServiceCollectionExtensions.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API key data model and service contracts</name>
  <files>
    Transcendence.Data/Models/Auth/ApiClientKey.cs
    Transcendence.Data/Repositories/Interfaces/IApiClientKeyRepository.cs
    Transcendence.Data/Repositories/Implementations/ApiClientKeyRepository.cs
    Transcendence.Service.Core/Services/Auth/Interfaces/IApiKeyService.cs
    Transcendence.Service.Core/Services/Auth/Implementations/ApiKeyService.cs
  </files>
  <action>
Create API key entity with hashed key storage and metadata (name, created, expires, revoked). Implement repository + service methods:
- Create key (returns plaintext once)
- Validate key
- Revoke key
- Rotate key
  </action>
  <verify>`dotnet build Transcendence.Service.Core`</verify>
  <done>API key lifecycle implemented with hashed persistence</done>
</task>

<task type="auto">
  <name>Task 2: Implement API key authentication handler and AppOnly policy</name>
  <files>
    Transcendence.WebAPI/Security/ApiKeyAuthenticationHandler.cs
    Transcendence.WebAPI/Security/AuthPolicies.cs
    Transcendence.WebAPI/Program.cs
  </files>
  <action>
Add custom authentication scheme reading `X-API-Key`. Wire scheme in `AddAuthentication` and add `AppOnly` policy in `AddAuthorization`.
Use middleware-level auth/claims instead of per-controller key parsing.
  </action>
  <verify>
1. Request without key returns 401 on AppOnly endpoint.
2. Request with valid key returns 200.
  </verify>
  <done>X-API-Key works end-to-end through middleware and policy</done>
</task>

<task type="auto">
  <name>Task 3: Add API key management endpoints</name>
  <files>
    Transcendence.WebAPI/Controllers/ApiKeysController.cs
    Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
    Transcendence.Data/Extensions/ServiceCollectionExtensions.cs
  </files>
  <action>
Add CRUD-style management endpoints for key creation/revocation/rotation.
Restrict these endpoints to policy-authorized callers (internal/admin bootstrap strategy).
  </action>
  <verify>Swagger shows API key management endpoints and auth requirements</verify>
  <done>Operational key management available for desktop app provisioning</done>
</task>

</tasks>

<acceptance_criteria>
1. `X-API-Key` authentication works on protected endpoints.
2. API keys are hashed at rest and revocation is enforced.
3. `AppOnly` policy is usable by other plans/endpoints.
4. AUTH-01 marked complete in phase summary after execution.
</acceptance_criteria>
