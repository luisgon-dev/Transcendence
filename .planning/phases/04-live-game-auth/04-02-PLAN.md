---
phase: 04-live-game-auth
plan: 02
type: execute
wave: 1
depends_on: ["04-01"]
files_modified:
  - Transcendence.Service.Core/Services/LiveGame/Models/LiveGameDtos.cs
  - Transcendence.Service.Core/Services/LiveGame/Interfaces/ILiveGameService.cs
  - Transcendence.Service.Core/Services/LiveGame/Implementations/LiveGameService.cs
  - Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  - Transcendence.WebAPI/Controllers/LiveGameController.cs
  - Transcendence.WebAPI/Program.cs
autonomous: true

must_haves:
  truths:
    - "GET /api/summoners/{region}/{gameName}/{tagLine}/live-game returns current live-game state (LIVE-01)"
    - "Spectator 404 is mapped to a successful not-in-game response, not a server error"
    - "Live-game endpoint uses short-lived cache to reduce Spectator API pressure"
  artifacts:
    - path: "Transcendence.Service.Core/Services/LiveGame/Implementations/LiveGameService.cs"
      provides: "Spectator wrapper + response mapping + caching"
      min_lines: 80
    - path: "Transcendence.WebAPI/Controllers/LiveGameController.cs"
      provides: "Live game lookup endpoint"
      exports: ["GET /api/summoners/{region}/{gameName}/{tagLine}/live-game"]
  key_links:
    - from: "LiveGameController"
      to: "ILiveGameService"
      via: "DI"
      pattern: "GetCurrentGameAsync"
    - from: "LiveGameService"
      to: "HybridCache"
      via: "GetOrCreateAsync with ~2-minute TTL"
      pattern: "GetOrCreateAsync"
---

<objective>
Implement live game lookup endpoint backed by Spectator API with graceful not-in-game handling.

Purpose: Deliver LIVE-01 baseline feature and establish live game service contracts for polling/enrichment plans.

Output: `GET /api/summoners/{region}/{gameName}/{tagLine}/live-game` with cached live-state response.
</objective>

<execution_context>
@C:\Users\luigon\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luigon\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-live-game-auth/04-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@Transcendence.Service.Core/Services/RiotApi/Implementations/SummonerService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create live game DTOs and service interface</name>
  <files>
    Transcendence.Service.Core/Services/LiveGame/Models/LiveGameDtos.cs
    Transcendence.Service.Core/Services/LiveGame/Interfaces/ILiveGameService.cs
  </files>
  <action>
Define response contracts for live state:
- state (`offline`, `lobby`, `in_game`, `ended`)
- game metadata (queue, start time, map)
- participants (summoner identity, champion, spells, team)
- freshness metadata (`lastUpdatedUtc`, `dataAgeSeconds`)
  </action>
  <verify>`dotnet build Transcendence.Service.Core`</verify>
  <done>Strongly-typed live-game contracts available for API + polling layers</done>
</task>

<task type="auto">
  <name>Task 2: Implement LiveGameService with Spectator mapping and cache</name>
  <files>
    Transcendence.Service.Core/Services/LiveGame/Implementations/LiveGameService.cs
    Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  </files>
  <action>
Implement Spectator API wrapper:
- Resolve summoner to required Spectator identifier
- Call Spectator endpoint
- Map 404 to not-in-game state
- Cache response with short TTL (~2 minutes)
  </action>
  <verify>Repeated calls for same summoner hit cache and return consistent payload</verify>
  <done>Live game read path stable and cache-protected</done>
</task>

<task type="auto">
  <name>Task 3: Add live game controller endpoint</name>
  <files>
    Transcendence.WebAPI/Controllers/LiveGameController.cs
    Transcendence.WebAPI/Program.cs
  </files>
  <action>
Add endpoint:
`GET /api/summoners/{region}/{gameName}/{tagLine}/live-game`
Protect with `AppOnly` or `AppOrUser` policy (based on rollout strategy).
  </action>
  <verify>
1. Known offline user returns `state=offline`.
2. Active game returns participant payload.
  </verify>
  <done>LIVE-01 endpoint delivered for client integration</done>
</task>

</tasks>

<acceptance_criteria>
1. Live game endpoint returns a result for both in-game and not-in-game states.
2. Spectator 404 no longer surfaces as 5xx.
3. Response includes freshness metadata and is cache-backed.
</acceptance_criteria>
