---
phase: 04-live-game-auth
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - Transcendence.Data/Models/LiveGame/LiveGameSnapshot.cs
  - Transcendence.Data/Repositories/Interfaces/ILiveGameSnapshotRepository.cs
  - Transcendence.Data/Repositories/Implementations/LiveGameSnapshotRepository.cs
  - Transcendence.Service.Core/Services/LiveGame/Models/LiveGamePollingState.cs
  - Transcendence.Service.Core/Services/Jobs/LiveGamePollingJob.cs
  - Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  - Transcendence.Service/Workers/DevelopmentWorker.cs
  - Transcendence.Service/Workers/ProductionWorker.cs
autonomous: true

must_haves:
  truths:
    - "Tracked summoners are polled with adaptive intervals by state (LIVE-01 hardening)"
    - "Live game transitions are persisted as snapshots"
    - "Polling loop respects rate-limit budget through batching/deduplication"
  artifacts:
    - path: "Transcendence.Service.Core/Services/Jobs/LiveGamePollingJob.cs"
      provides: "Hangfire job for adaptive polling and snapshot persistence"
      min_lines: 120
    - path: "Transcendence.Data/Models/LiveGame/LiveGameSnapshot.cs"
      provides: "Persistent historical state for live game transitions"
      min_lines: 25
  key_links:
    - from: "LiveGamePollingJob"
      to: "ILiveGameService"
      via: "Fetch current state"
      pattern: "GetCurrentGameAsync"
    - from: "LiveGamePollingJob"
      to: "ILiveGameSnapshotRepository"
      via: "Persist snapshots"
      pattern: "Save"
---

<objective>
Implement background polling with adaptive intervals and snapshot persistence.

Purpose: Meet live-game freshness/rate-limit requirements and avoid expensive per-request Spectator calls.

Output: Scheduled `LiveGamePollingJob` with state transitions and durable snapshots.
</objective>

<execution_context>
@C:\Users\luigon\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luigon\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-live-game-auth/04-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@Transcendence.Service/Workers/DevelopmentWorker.cs
@Transcendence.Service/Workers/ProductionWorker.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snapshot model and repository</name>
  <files>
    Transcendence.Data/Models/LiveGame/LiveGameSnapshot.cs
    Transcendence.Data/Repositories/Interfaces/ILiveGameSnapshotRepository.cs
    Transcendence.Data/Repositories/Implementations/LiveGameSnapshotRepository.cs
  </files>
  <action>
Create snapshot schema for:
- Summoner identity (PUUID + region)
- Detected state
- Current game id (nullable)
- Poll timestamp
- Minimal serialized payload for debugging/analysis
  </action>
  <verify>Migration builds and applies cleanly</verify>
  <done>Snapshot persistence available to polling job</done>
</task>

<task type="auto">
  <name>Task 2: Implement adaptive LiveGamePollingJob</name>
  <files>
    Transcendence.Service.Core/Services/LiveGame/Models/LiveGamePollingState.cs
    Transcendence.Service.Core/Services/Jobs/LiveGamePollingJob.cs
    Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  </files>
  <action>
Implement tracked-summoner polling with transition-aware intervals:
- offline => 5m
- lobby/champ-select => 30s
- in-game => 60s
Batch by game where possible and deduplicate same-game participant queries.
Persist transition snapshots and queue follow-up processing when game ends.
  </action>
  <verify>Logs show interval changes and transition events for at least one tracked summoner</verify>
  <done>Adaptive polling active with persisted transitions</done>
</task>

<task type="auto">
  <name>Task 3: Schedule polling job in workers</name>
  <files>
    Transcendence.Service/Workers/DevelopmentWorker.cs
    Transcendence.Service/Workers/ProductionWorker.cs
  </files>
  <action>
Register recurring Hangfire schedule for polling coordinator and ensure development worker behavior remains predictable.
  </action>
  <verify>Hangfire dashboard lists live-game polling recurring job</verify>
  <done>Polling runs automatically in both development and production environments</done>
</task>

</tasks>

<acceptance_criteria>
1. Polling intervals follow adaptive state policy.
2. Snapshot rows capture state transitions and timestamps.
3. Job scheduling is visible in Hangfire and survives restart.
</acceptance_criteria>
