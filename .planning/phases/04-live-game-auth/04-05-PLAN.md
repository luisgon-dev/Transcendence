---
phase: 04-live-game-auth
plan: 05
type: execute
wave: 3
depends_on: ["04-01"]
files_modified:
  - Transcendence.Data/Models/Auth/UserAccount.cs
  - Transcendence.Data/Models/Auth/UserRefreshToken.cs
  - Transcendence.Data/Repositories/Interfaces/IUserAccountRepository.cs
  - Transcendence.Data/Repositories/Implementations/UserAccountRepository.cs
  - Transcendence.Service.Core/Services/Auth/Models/AuthDtos.cs
  - Transcendence.Service.Core/Services/Auth/Interfaces/IUserAuthService.cs
  - Transcendence.Service.Core/Services/Auth/Interfaces/IJwtService.cs
  - Transcendence.Service.Core/Services/Auth/Implementations/UserAuthService.cs
  - Transcendence.Service.Core/Services/Auth/Implementations/JwtService.cs
  - Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  - Transcendence.WebAPI/Controllers/AuthController.cs
  - Transcendence.WebAPI/Program.cs
autonomous: true

must_haves:
  truths:
    - "Users can register and login with email/password (AUTH-02)"
    - "JWT bearer authentication works for UserOnly endpoints"
    - "Access + refresh token flow exists with secure token storage"
    - "Password reset initiation endpoint is available"
  artifacts:
    - path: "Transcendence.WebAPI/Controllers/AuthController.cs"
      provides: "Register/login/refresh/password reset endpoints"
      exports: ["POST /api/auth/register", "POST /api/auth/login", "POST /api/auth/refresh"]
    - path: "Transcendence.WebAPI/Program.cs"
      provides: "JWT bearer registration and multi-scheme auth setup"
      contains: "AddJwtBearer"
    - path: "Transcendence.Service.Core/Services/Auth/Implementations/JwtService.cs"
      provides: "Token issuance and validation utilities"
      min_lines: 80
  key_links:
    - from: "AuthController"
      to: "IUserAuthService"
      via: "Service orchestration"
      pattern: "LoginAsync"
    - from: "UserOnly policy"
      to: "JWT Bearer scheme"
      via: "Authorization policy config"
      pattern: "UserOnly"
---

<objective>
Implement JWT user authentication for account-based features.

Purpose: Deliver AUTH-02 and establish `UserOnly` authorization for user-owned data.

Output: Registration/login/refresh/password-reset-init endpoints and JWT middleware configuration.
</objective>

<execution_context>
@C:\Users\luigon\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luigon\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-live-game-auth/04-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@Transcendence.WebAPI/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user account and refresh token persistence</name>
  <files>
    Transcendence.Data/Models/Auth/UserAccount.cs
    Transcendence.Data/Models/Auth/UserRefreshToken.cs
    Transcendence.Data/Repositories/Interfaces/IUserAccountRepository.cs
    Transcendence.Data/Repositories/Implementations/UserAccountRepository.cs
  </files>
  <action>
Add user account schema with password hash and email normalization.
Store refresh tokens hashed and revocable with expiration metadata.
  </action>
  <verify>Migration applies and repository queries pass build/runtime checks</verify>
  <done>User auth persistence layer available</done>
</task>

<task type="auto">
  <name>Task 2: Implement JWT + auth services</name>
  <files>
    Transcendence.Service.Core/Services/Auth/Models/AuthDtos.cs
    Transcendence.Service.Core/Services/Auth/Interfaces/IUserAuthService.cs
    Transcendence.Service.Core/Services/Auth/Interfaces/IJwtService.cs
    Transcendence.Service.Core/Services/Auth/Implementations/UserAuthService.cs
    Transcendence.Service.Core/Services/Auth/Implementations/JwtService.cs
  </files>
  <action>
Implement register/login/refresh flows with secure password hashing.
Access tokens short-lived, refresh tokens longer-lived and rotatable/revocable.
  </action>
  <verify>Auth service unit/integration checks validate token issuance and refresh rotation</verify>
  <done>Core user auth logic complete</done>
</task>

<task type="auto">
  <name>Task 3: Add AuthController and configure UserOnly policy</name>
  <files>
    Transcendence.WebAPI/Controllers/AuthController.cs
    Transcendence.WebAPI/Program.cs
    Transcendence.Service.Core/Services/Extensions/ServiceCollectionExtensions.cs
  </files>
  <action>
Expose auth endpoints and register JWT bearer scheme alongside existing API key scheme.
Define policies:
- `AppOnly`
- `UserOnly`
- `AppOrUser`
  </action>
  <verify>
1. Register/login returns valid JWT.
2. UserOnly endpoint rejects API key-only request.
  </verify>
  <done>JWT auth integrated with policy-based authorization</done>
</task>

</tasks>

<acceptance_criteria>
1. AUTH-02 flows are functional end-to-end.
2. JWT and API key schemes coexist without controller parsing logic.
3. Password reset initiation endpoint exists for client UX flow.
</acceptance_criteria>
