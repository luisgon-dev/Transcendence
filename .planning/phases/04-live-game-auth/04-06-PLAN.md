---
phase: 04-live-game-auth
plan: 06
type: execute
wave: 3
depends_on: ["04-04", "04-05"]
files_modified:
  - Transcendence.Data/Models/Auth/UserFavoriteSummoner.cs
  - Transcendence.Data/Models/Auth/UserPreferences.cs
  - Transcendence.Data/Repositories/Interfaces/IUserPreferencesRepository.cs
  - Transcendence.Data/Repositories/Implementations/UserPreferencesRepository.cs
  - Transcendence.Service.Core/Services/Auth/Models/UserPreferenceDtos.cs
  - Transcendence.Service.Core/Services/Auth/Interfaces/IUserPreferencesService.cs
  - Transcendence.Service.Core/Services/Auth/Implementations/UserPreferencesService.cs
  - Transcendence.WebAPI/Controllers/UserPreferencesController.cs
  - Transcendence.WebAPI/Controllers/AnalyticsController.cs
  - Transcendence.WebAPI/Controllers/ChampionAnalyticsController.cs
autonomous: true

must_haves:
  truths:
    - "Users can save and list favorite summoners (AUTH-03)"
    - "User preferences persist across sessions"
    - "Favorites/preferences endpoints require UserOnly policy"
    - "Admin-style cache invalidation endpoints are no longer unauthenticated"
  artifacts:
    - path: "Transcendence.WebAPI/Controllers/UserPreferencesController.cs"
      provides: "Favorites/preferences CRUD endpoints"
      exports: ["GET /api/users/me/favorites", "POST /api/users/me/favorites", "PUT /api/users/me/preferences"]
    - path: "Transcendence.Service.Core/Services/Auth/Implementations/UserPreferencesService.cs"
      provides: "Business logic for favorite/preference persistence"
      min_lines: 80
  key_links:
    - from: "UserPreferencesController"
      to: "IUserPreferencesService"
      via: "DI"
      pattern: "GetMy"
    - from: "AnalyticsController/ChampionAnalyticsController"
      to: "AppOnly policy"
      via: "Authorize attribute"
      pattern: "Authorize"
---

<objective>
Deliver user personalization features and close auth gaps on admin endpoints.

Purpose: Complete AUTH-03 and ensure sensitive operational endpoints are protected by policy.

Output: Favorites/preferences APIs for authenticated users plus secured analytics cache controls.
</objective>

<execution_context>
@C:\Users\luigon\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luigon\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-live-game-auth/04-CONTEXT.md
@Transcendence.WebAPI/Controllers/AnalyticsController.cs
@Transcendence.WebAPI/Controllers/ChampionAnalyticsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add favorite summoner + preferences persistence</name>
  <files>
    Transcendence.Data/Models/Auth/UserFavoriteSummoner.cs
    Transcendence.Data/Models/Auth/UserPreferences.cs
    Transcendence.Data/Repositories/Interfaces/IUserPreferencesRepository.cs
    Transcendence.Data/Repositories/Implementations/UserPreferencesRepository.cs
  </files>
  <action>
Add user-owned tables for favorites and preferences with unique constraints and timestamps.
Model links to summoner identities using stable IDs (PUUID/summoner GUID), not mutable names.
  </action>
  <verify>Migration applies and unique constraints prevent duplicate favorites</verify>
  <done>Data layer supports persisted personalization</done>
</task>

<task type="auto">
  <name>Task 2: Implement personalization service + DTOs</name>
  <files>
    Transcendence.Service.Core/Services/Auth/Models/UserPreferenceDtos.cs
    Transcendence.Service.Core/Services/Auth/Interfaces/IUserPreferencesService.cs
    Transcendence.Service.Core/Services/Auth/Implementations/UserPreferencesService.cs
  </files>
  <action>
Implement service methods:
- list/add/remove favorites
- get/update preferences (region defaults, polling preferences, overlay options)
- validation for ownership and duplicate entries
  </action>
  <verify>`dotnet build Transcendence.Service.Core`</verify>
  <done>Business logic complete for AUTH-03 resources</done>
</task>

<task type="auto">
  <name>Task 3: Add UserOnly endpoints and secure existing admin routes</name>
  <files>
    Transcendence.WebAPI/Controllers/UserPreferencesController.cs
    Transcendence.WebAPI/Controllers/AnalyticsController.cs
    Transcendence.WebAPI/Controllers/ChampionAnalyticsController.cs
  </files>
  <action>
Create `users/me` endpoints protected with `UserOnly`.
Apply `AppOnly` (or stronger admin policy) to manual cache invalidation endpoints introduced in Phase 3.
  </action>
  <verify>
1. JWT-authenticated user can manage favorites/preferences.
2. Anonymous requests to personalization/admin endpoints return 401/403.
  </verify>
  <done>AUTH-03 complete and prior auth TODOs resolved</done>
</task>

</tasks>

<acceptance_criteria>
1. Favorites/preferences persist and are user-scoped.
2. AUTH-03 functionality available via JWT-protected endpoints.
3. Manual operational endpoints are protected by auth policy.
</acceptance_criteria>
